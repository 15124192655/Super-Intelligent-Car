<html>
<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
<script>
function send(ws,data){
	ws.send(JSON.stringify(data));
}
function builddata(id,data){
	data['handle']=id;
	return data;
}
function sendid(ws,id,data){
	send(ws,builddata(id,data));
}

var heatbeatcount=0;
var handlers={};
var ws;
handlers['chika']=function(ws,data){
	heatbeatcount--;
	$(".log").append("[HEARTBEAT MESSAGE]"+data['msg']).append("\n");
};
$(document).ready(function(){
	ws=new WebSocket('ws://10.122.242.183:9090');
	ws.onopen=function(e){
		console.log('websocket connected');
	};
	
	ws.onmessage=function(e){
		dec=JSON.parse(e.data);
        //TODO: consume data here.
		if('handle' in dec && dec['handle'] in handlers){
			handlers[dec['handle']](ws,dec);
		}
	};
	ws.onclose=function(e){
		console.log('websocket disconnected');
		alert("服务器断开连接");
	};

	//movement controller
	$(".mbtn").mouseup(function(){
		send(ws,builddata('move',{'direction':'S',}));
	});
	$(".mbtn").mousedown(function(){
		send(ws,builddata('move',{'direction':$(this).html(),}));
	});
	$(".rbtn").click(function(){
		send(ws,builddata('motor',{'id':$(this).html(),'angle':233,}));
	});
    $(".cbtn").click(function(){
    	send(ws,builddata('cammove',{'axis':$(this).html(),'angle':10,}));
    });

	setInterval(function(){
		send(ws,builddata('chika',{'version':'0.1.0'}));
		heatbeatcount++;
		if(heatbeatcount>2){
			$(".log").append("[WARNING]连接过慢，服务器是否卡机？\n");
		}
	},5000);
});
function d(id,rot){
    send(ws,builddata('cammove',{'axis':id,'angle':rot,}));
}
</script>

<style type="text/css">
.btn {
	text-align: center;
}
</style>

 

<head>
    <title>control page</title>
</head>
<body>
<img id="streamimage" class="xform" src="http://10.122.242.183:8080/?action=stream">
<textarea class="log">
返回数据
</textarea>
<div><!--控制部分-->
	<div style="
		position: relative;
		border: solid;
		width: 75px;">
		
		<div class="mbtn" style="
		text-align: center;
		/* background-color: green; */">F</div>
		<div>
			<div  class="mbtn" style="
			float: left;
			width: 50%;
			text-align: center;">L</div>
			<div class="mbtn" style="
			float: left;
			width: 50%;
			text-align: center;">R</div>
		</div>

		<div class="mbtn" style="text-align: center;">B</div>
	</div>
	<div style="
		position: relative;
		border: solid;
		width: 75px;">
		
		<div class="rbtn" style="
		text-align: center;
		/* background-color: green; */">i</div>
		<div>
			<div  class="rbtn" style="
			float: left;
			width: 50%;
			text-align: center;">j</div>
			<div class="rbtn" style="
			float: left;
			width: 50%;
			text-align: center;">l</div>
		</div>

		<div class="rbtn" style="text-align: center;">k</div>
	</div>
    <div style="
		position: relative;
		border: solid;
		width: 75px;">
		
		<div class="cbtn" style="
		text-align: center;
		/* background-color: green; */">p1</div>

		<div class="cbtn" style="text-align: center;">p2</div>
	</div>
</div><!--控制部分end-->



</body>

</html>
